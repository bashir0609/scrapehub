<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Company Social Finder - ScrapeHub</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üîç</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* Navigation Header */
        .nav-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 15px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 20px;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
            text-decoration: none;
        }

        .nav-brand:hover {
            color: #764ba2;
        }

        .nav-menu {
            display: flex;
            gap: 5px;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-menu-item {
            margin: 0;
        }

        .nav-menu-link {
            display: block;
            padding: 10px 20px;
            color: #333;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }

        .nav-menu-link:hover {
            background: #f0f0f0;
            color: #667eea;
        }

        .nav-menu-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 100px;
            font-family: 'Courier New', monospace;
            resize: vertical;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .example-btn {
            background: #f0f0f0;
            color: #333;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
            transition: background 0.3s;
        }

        .example-btn:hover {
            background: #e0e0e0;
        }

        .selector-row {
            display: grid;
            grid-template-columns: 1fr 2fr auto;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .selector-row input {
            margin: 0;
        }

        .btn-small {
            padding: 10px 20px;
            width: auto;
            font-size: 14px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .response-section {
            margin-top: 20px;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .response-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            max-height: 600px;
            overflow-y: auto;
        }

        .response-content pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .quick-selector-btn {
            background: white;
            border: 1px solid #0ea5e9;
            color: #0369a1;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
        }

        .quick-selector-btn:hover {
            background: #e0f2fe;
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(14, 165, 233, 0.2);
        }

        @media (max-width: 768px) {
            .nav-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .nav-menu-link {
                padding: 8px 15px;
                font-size: 0.9em;
            }

            .selector-row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <nav class="nav-header">
        <div class="nav-container">
            <a href="/" class="nav-brand">
                <span>üîç</span>
                <span>ScrapeHub</span>
            </a>
            <ul class="nav-menu">
                <li class="nav-menu-item">
                    <a href="/" class="nav-menu-link">Universal API Client</a>
                </li>
                <li class="nav-menu-item">
                    <a href="/company-social-finder/" class="nav-menu-link active">Company Social Finder</a>
                </li>
                <li class="nav-menu-item">
                    <a href="/social-scraper/" class="nav-menu-link">Social Scraper</a>
                </li>
                <li class="nav-menu-item">
                    <a href="/ecommerce-scraper/" class="nav-menu-link">E-commerce Scraper</a>
                </li>
                <li class="nav-menu-item">
                    <a href="/rapidapi-scraper/" class="nav-menu-link">RapidAPI Scraper</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="header">
            <h1>üîç Company Social Finder</h1>
            <p>Find company information and social media profiles from websites</p>
        </div>

        <div class="card">
            <form id="webScrapeForm">
                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                        <label for="url" id="urlLabel" style="margin: 0;">Website URL *</label>
                        <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; font-size: 14px; cursor: pointer; padding: 8px 12px; background: #f0f9ff; border-radius: 6px; border: 1px solid #0ea5e9;">
                            <input type="checkbox" id="bulkMode" onchange="toggleBulkMode()">
                            <span style="color: #0369a1; font-weight: 600;">üì¶ Bulk Mode (Multiple URLs + CSV Upload)</span>
                        </label>
                    </div>
                    <input type="url" id="url" name="url" required 
                           placeholder="https://example.com">
                    <textarea id="bulkUrls" name="bulkUrls" 
                              placeholder="Enter one URL per line:&#10;https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3"
                              style="display: none; min-height: 120px; font-family: 'Courier New', monospace; font-size: 13px;"></textarea>
                    
                    <!-- CSV Upload Section - Always in DOM, visibility controlled by JavaScript -->
                    <div id="csvUploadSection" class="csv-upload-section" style="display: none !important; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px dashed #0ea5e9; position: relative;">
                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                            <span style="font-size: 1.5em;">üìÑ</span>
                            <label for="csvFile" style="margin: 0; font-size: 15px; font-weight: 600; color: #0369a1; cursor: pointer;">
                                Upload CSV File with URLs
                            </label>
                        </div>
                        <input type="file" id="csvFile" name="csvFile" accept=".csv,.txt" 
                               style="width: 100%; padding: 10px; border: 2px solid #0ea5e9; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                        <small style="color: #075985; font-size: 12px; display: block; margin-top: 8px; line-height: 1.5;">
                            üìã Upload a CSV file with URLs. The system will detect columns and let you select which one contains the URLs.<br>
                            <strong>Supported formats:</strong> CSV files (.csv) or text files (.txt) with one URL per line
                        </small>
                        
                        <!-- Column Selection (shown after file upload) -->
                        <div id="csvColumnSelection" style="display: none; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #0ea5e9;">
                            <label for="urlColumn" style="display: block; margin-bottom: 8px; font-size: 14px; font-weight: 600; color: #0369a1;">
                                Select Column Containing URLs:
                            </label>
                            <select id="urlColumn" style="width: 100%; padding: 8px; border: 2px solid #e0e0e0; border-radius: 6px; font-size: 14px; margin-bottom: 10px;">
                                <option value="">-- Select Column --</option>
                            </select>
                            <button type="button" id="applyColumnBtn" class="example-btn" style="background: #0ea5e9; color: white; width: 100%;">
                                Apply & Extract URLs
                            </button>
                        </div>
                        
                        <!-- CSV Preview -->
                        <div id="csvPreview" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <strong style="font-size: 13px;">Preview:</strong>
                                <button type="button" onclick="clearCsvUpload()" style="background: #fee2e2; color: #991b1b; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">
                                    Clear
                                </button>
                            </div>
                            <div id="csvUrlsList" style="margin-top: 5px; font-size: 12px; color: #333;"></div>
                        </div>
                    </div>
                    <small style="color: #333; font-size: 12px; display: block; margin-top: 5px;">
                        <span id="urlHint">Enter a single URL to scrape</span>
                    </small>
                </div>

                <div class="form-group">
                    <label>CSS Selectors (Optional)</label>
                    
                    <!-- Auto-extraction notice -->
                    <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #10b981;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <span style="font-size: 1.5em;">‚ú®</span>
                            <strong style="color: #065f46;">Automatic Business Info Extraction</strong>
                        </div>
                        <p style="color: #047857; margin: 0; font-size: 14px;">
                            The following fields are <strong>automatically extracted</strong> from every website:
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin-top: 10px;">
                            <div style="background: white; padding: 8px; border-radius: 4px; font-size: 13px;">üè¢ Company Name</div>
                            <div style="background: white; padding: 8px; border-radius: 4px; font-size: 13px;">üè† Homepage URL</div>
                            <div style="background: white; padding: 8px; border-radius: 4px; font-size: 13px;">üìß Email</div>
                            <div style="background: white; padding: 8px; border-radius: 4px; font-size: 13px;">üìû Phone</div>
                            <div style="background: white; padding: 8px; border-radius: 4px; font-size: 13px;">üìù Contact Page URL</div>
                        </div>
                        <p style="color: #047857; margin: 10px 0 5px 0; font-size: 13px; font-weight: 600;">
                            Social Media Platforms (separate fields):
                        </p>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px; margin-top: 5px;">
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üíº LinkedIn</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üìò Facebook</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üê¶ Twitter/X</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üì∑ Instagram</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">‚ñ∂Ô∏è YouTube</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üéµ TikTok</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üìå Pinterest</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üëª Snapchat</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">ü§ñ Reddit</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üíª GitHub</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">‚úçÔ∏è Medium</div>
                            <div style="background: white; padding: 6px; border-radius: 4px; font-size: 12px;">üé® Behance</div>
                        </div>
                        <p style="color: #047857; margin: 10px 0 0 0; font-size: 12px; font-style: italic;">
                            You can scrape with just a URL! Add custom selectors below only if you need additional fields.
                        </p>
                    </div>
                    
                    <!-- Example Selectors Section -->
                    <div style="background: #f0f9ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #0ea5e9;">
                        <div id="exampleSelectorsHeader" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; cursor: pointer;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.3em;">üìö</span>
                                <strong style="color: #0369a1;">Example CSS Selectors</strong>
                            </div>
                            <span id="exampleSelectorsToggle" style="font-size: 1.2em; color: #0369a1; user-select: none;">‚ñº</span>
                        </div>
                        <div id="exampleSelectorsContent" style="display: none;">
                        <p style="color: #075985; margin: 0 0 10px 0; font-size: 13px;">
                            Use these examples to understand how to write CSS selectors:
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px; font-size: 13px;">
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                h1
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract all H1 headings
                            </div>
                            
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                .title
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract elements with class "title"
                            </div>
                            
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                #main-content
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract element with ID "main-content"
                            </div>
                            
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                a[href]
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract all links
                            </div>
                            
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                img[src]
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract all images
                            </div>
                        </div>
                        <p style="color: #075985; margin: 5px 0 0 0; font-size: 12px; font-weight: 600;">
                            XPath Examples (use xpath: prefix or start with //):
                        </p>
                        <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 8px; margin-top: 5px; font-size: 13px;">
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                //h1
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract all H1 elements (XPath)
                            </div>
                            
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                //div[@class='title']
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract divs with class "title" (XPath)
                            </div>
                            
                            <div style="font-family: 'Courier New', monospace; background: white; padding: 8px; border-radius: 4px; font-weight: 600; color: #0369a1;">
                                //a[@href]
                            </div>
                            <div style="background: white; padding: 8px; border-radius: 4px; color: #333;">
                                Extract all links (XPath)
                            </div>
                        </div>
                        <p style="color: #075985; margin: 10px 0 0 0; font-size: 12px; font-style: italic;">
                            üí° Tip: Use browser DevTools (F12) to inspect elements and find the right selectors! Tables are automatically extracted.
                        </p>
                        </div>
                    </div>
                    
                    <div id="selectorsContainer">
                        <!-- No default selector row - user can add if needed -->
                    </div>
                    <button type="button" class="example-btn" onclick="addSelector()">+ Add Custom Selector</button>
                    <small style="color: #333; font-size: 12px; display: block; margin-top: 5px;">
                        Add custom CSS selectors only if you need to extract additional fields beyond the automatically extracted business information.
                    </small>
                </div>

                <div class="form-group">
                    <label for="scrapingMethod">Scraping Method</label>
                    <select id="scrapingMethod" name="scrapingMethod">
                        <option value="beautifulsoup">BeautifulSoup (HTML Only)</option>
                        <option value="selenium">Selenium (JavaScript Rendering)</option>
                        <option value="playwright">Playwright (JavaScript Rendering)</option>
                    </select>
                    <small style="color: #333; font-size: 12px; display: block; margin-top: 5px;">
                        Use JavaScript rendering for dynamic content. Requires Selenium/Playwright installed.
                    </small>
                </div>

                <div class="form-group">
                    <label for="userAgent">User Agent (Optional)</label>
                    <input type="text" id="userAgent" name="userAgent" 
                           placeholder="Leave empty for default">
                </div>

                <div class="form-group">
                    <label for="waitTime">Wait Time (seconds)</label>
                    <input type="number" id="waitTime" name="waitTime" value="0" min="0" step="0.5">
                    <small style="color: #333; font-size: 12px; display: block; margin-top: 5px;">
                        Time to wait before scraping each page (useful for slow-loading pages and JavaScript rendering)
                    </small>
                </div>

                <div class="form-group" id="delayBetweenUrlsGroup" style="display: none;">
                    <label for="delayBetweenUrls">Delay Between URLs (seconds)</label>
                    <input type="number" id="delayBetweenUrls" name="delayBetweenUrls" value="0" min="0" step="0.1">
                    <small style="color: #333; font-size: 12px; display: block; margin-top: 5px;">
                        Processing delay between URLs in bulk mode (helps avoid rate limiting and server overload)
                    </small>
                </div>

                <button type="submit" class="btn" id="submitBtn">Scrape Website</button>
            </form>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p style="margin-top: 10px;">Scraping website...</p>
            </div>

            <div class="response-section" id="responseSection" style="display: none;">
                <div class="response-header">
                    <h3>Scraped Data</h3>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span class="status-badge" id="statusBadge"></span>
                        <button type="button" class="example-btn" id="exportCsvBtn" style="display: none;">Export CSV</button>
                        <button type="button" class="example-btn" id="exportJsonBtn" style="display: none;">Export JSON</button>
                    </div>
                </div>
                <div class="response-content">
                    <pre id="responseContent"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        const form = document.getElementById('webScrapeForm');
        const loading = document.getElementById('loading');
        const responseSection = document.getElementById('responseSection');
        const responseContent = document.getElementById('responseContent');
        const statusBadge = document.getElementById('statusBadge');
        const submitBtn = document.getElementById('submitBtn');
        const exportCsvBtn = document.getElementById('exportCsvBtn');
        const exportJsonBtn = document.getElementById('exportJsonBtn');
        let currentData = null;

        function addSelector() {
            const container = document.getElementById('selectorsContainer');
            const row = document.createElement('div');
            row.className = 'selector-row';
            row.innerHTML = `
                <input type="text" placeholder="Field Name (e.g., title)" class="field-name" required>
                <input type="text" placeholder="CSS Selector (e.g., h1.title)" class="css-selector" required>
                <button type="button" class="btn btn-small" onclick="removeSelector(this)">Remove</button>
            `;
            container.appendChild(row);
        }

        function removeSelector(btn) {
            const container = document.getElementById('selectorsContainer');
            btn.closest('.selector-row').remove();
        }

        function toggleExampleSelectors() {
            const content = document.getElementById('exampleSelectorsContent');
            const toggle = document.getElementById('exampleSelectorsToggle');
            
            if (!content || !toggle) {
                console.error('Example selectors elements not found:', { content, toggle });
                return;
            }
            
            const computedStyle = window.getComputedStyle(content);
            const isHidden = content.style.display === 'none' || 
                           computedStyle.display === 'none' ||
                           content.style.getPropertyValue('display') === 'none';
            
            if (isHidden) {
                content.style.cssText = 'display: block !important;';
                toggle.textContent = '‚ñ≤';
            } else {
                content.style.cssText = 'display: none !important;';
                toggle.textContent = '‚ñº';
            }
        }
        
        // Make function globally accessible
        window.toggleExampleSelectors = toggleExampleSelectors;

        function toggleBulkMode() {
            const bulkMode = document.getElementById('bulkMode');
            if (!bulkMode) return;
            
            const isBulkMode = bulkMode.checked;
            const urlInput = document.getElementById('url');
            const bulkUrls = document.getElementById('bulkUrls');
            const csvUploadSection = document.getElementById('csvUploadSection');
            const delayBetweenUrlsGroup = document.getElementById('delayBetweenUrlsGroup');
            const urlHint = document.getElementById('urlHint');
            const urlLabel = document.getElementById('urlLabel');
            
            if (isBulkMode) {
                if (urlInput) urlInput.style.display = 'none';
                if (bulkUrls) {
                    bulkUrls.style.display = 'block';
                    bulkUrls.required = false;
                }
                if (csvUploadSection) {
                    // Use cssText to set all styles at once with !important
                    csvUploadSection.style.cssText = 'display: block !important; visibility: visible !important; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px dashed #0ea5e9; position: relative;';
                    csvUploadSection.removeAttribute('hidden');
                    console.log('CSV upload section should now be visible', {
                        element: csvUploadSection,
                        display: window.getComputedStyle(csvUploadSection).display,
                        visibility: window.getComputedStyle(csvUploadSection).visibility
                    });
                } else {
                    console.error('csvUploadSection element not found!');
                    alert('CSV upload section element not found. Please refresh the page.');
                }
                if (delayBetweenUrlsGroup) delayBetweenUrlsGroup.style.display = 'block';
                if (urlInput) urlInput.required = false;
                if (urlHint) urlHint.textContent = 'Enter URLs manually or upload a CSV file (no limit)';
                if (urlLabel) urlLabel.textContent = 'Website URL(s) *';
            } else {
                if (urlInput) {
                    urlInput.style.display = 'block';
                    urlInput.required = true;
                }
                if (bulkUrls) {
                    bulkUrls.style.display = 'none';
                    bulkUrls.required = false;
                }
                if (csvUploadSection) {
                    // Force hide with !important
                    csvUploadSection.style.cssText = 'display: none !important; visibility: hidden !important;';
                    // Also clear any CSV-related data
                    const csvFile = document.getElementById('csvFile');
                    if (csvFile) csvFile.value = '';
                    const csvColumnSelection = document.getElementById('csvColumnSelection');
                    if (csvColumnSelection) csvColumnSelection.style.display = 'none';
                    const csvPreview = document.getElementById('csvPreview');
                    if (csvPreview) csvPreview.style.display = 'none';
                }
                if (delayBetweenUrlsGroup) delayBetweenUrlsGroup.style.display = 'none';
                if (urlHint) urlHint.textContent = 'Enter a single URL to scrape';
                if (urlLabel) urlLabel.textContent = 'Website URL *';
            }
        }

        let csvData = null; // Store parsed CSV data
        let csvColumns = []; // Store column names/indices

        // Handle CSV file upload
        document.getElementById('csvFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) {
                csvData = null;
                csvColumns = [];
                document.getElementById('csvColumnSelection').style.display = 'none';
                document.getElementById('csvPreview').style.display = 'none';
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const text = event.target.result;
                const parsed = parseCsvFile(text);
                csvData = parsed.data;
                csvColumns = parsed.columns;
                
                if (csvColumns.length > 0) {
                    // Show column selection
                    const columnSelect = document.getElementById('urlColumn');
                    const columnSelectionDiv = document.getElementById('csvColumnSelection');
                    
                    if (!columnSelect || !columnSelectionDiv) {
                        console.error('Column selection elements not found!');
                        return;
                    }
                    
                    columnSelect.innerHTML = '<option value="">-- Select Column --</option>';
                    
                    csvColumns.forEach((col, index) => {
                        const option = document.createElement('option');
                        option.value = index;
                        option.textContent = `Column ${index + 1}${col.name ? `: ${col.name}` : ''} (${col.sample})`;
                        columnSelect.appendChild(option);
                    });
                    
                    // Force show column selection with !important
                    columnSelectionDiv.style.setProperty('display', 'block', 'important');
                    columnSelectionDiv.style.cssText = 'display: block !important; margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #0ea5e9;';
                    document.getElementById('csvPreview').style.display = 'none';
                    console.log('Column selection shown', columnSelectionDiv);
                } else {
                    // Simple line-by-line format
                    const urls = extractUrlsFromLines(text);
                    if (urls.length > 0) {
                        document.getElementById('bulkUrls').value = urls.join('\n');
                        showUrlPreview(urls);
                    } else {
                        alert('No valid URLs found in file');
                    }
                }
            };
            reader.readAsText(file);
        });

        // Handle column selection
        document.getElementById('applyColumnBtn').addEventListener('click', function() {
            const selectedColumn = parseInt(document.getElementById('urlColumn').value);
            if (isNaN(selectedColumn) || !csvData) return;
            
            const urls = extractUrlsFromColumn(csvData, selectedColumn);
            if (urls.length > 0) {
                document.getElementById('bulkUrls').value = urls.join('\n');
                showUrlPreview(urls);
            } else {
                alert('No valid URLs found in selected column');
            }
        });

        function parseCsvFile(csvText) {
            const lines = csvText.split('\n').map(line => line.trim()).filter(line => line);
            if (lines.length === 0) return { data: [], columns: [] };
            
            // Try to detect if it's CSV format (has commas) or simple line-by-line
            const firstLine = lines[0];
            const hasCommas = firstLine.includes(',');
            
            if (!hasCommas) {
                // Simple line-by-line format
                return { data: [], columns: [] };
            }
            
            // Parse CSV (handle quoted values)
            const data = [];
            const columns = [];
            
            // Parse header (first line)
            const headerLine = lines[0];
            const headerColumns = parseCsvLine(headerLine);
            
            // Check if first row looks like headers (contains text, not URLs)
            const isHeaderRow = headerColumns.some(col => 
                !col.startsWith('http://') && !col.startsWith('https://')
            );
            
            let startIndex = isHeaderRow ? 1 : 0;
            
            // Parse data rows
            for (let i = startIndex; i < lines.length; i++) {
                const columns = parseCsvLine(lines[i]);
                data.push(columns);
            }
            
            // Create column info
            for (let i = 0; i < headerColumns.length; i++) {
                const colName = isHeaderRow ? headerColumns[i] : `Column ${i + 1}`;
                const sample = data.length > 0 && data[0][i] ? 
                    (data[0][i].length > 30 ? data[0][i].substring(0, 30) + '...' : data[0][i]) : 
                    '(empty)';
                columns.push({
                    index: i,
                    name: colName,
                    sample: sample
                });
            }
            
            return { data, columns };
        }

        function parseCsvLine(line) {
            const columns = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    columns.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            columns.push(current.trim()); // Add last column
            
            return columns;
        }

        function normalizeUrl(url) {
            if (!url) return null;
            
            // Remove whitespace and trailing punctuation
            url = url.trim().replace(/[.,;)\]}]+$/, '');
            
            if (!url) return null;
            
            // If URL doesn't start with http:// or https://, add https://
            if (!url.match(/^https?:\/\//i)) {
                // Check if it looks like a domain
                if (url.includes('.') && !url.startsWith('/')) {
                    url = 'https://' + url;
                } else {
                    return null; // Invalid URL format
                }
            }
            
            // Remove trailing slash (except for root)
            if (url.endsWith('/') && url.split('/').length > 4) {
                url = url.slice(0, -1);
            }
            
            return url;
        }

        function extractUrlsFromColumn(data, columnIndex) {
            const urls = [];
            const seen = new Set(); // Track unique URLs
            
            for (const row of data) {
                if (row[columnIndex]) {
                    const value = row[columnIndex].trim();
                    const normalized = normalizeUrl(value);
                    if (normalized && !seen.has(normalized)) {
                        urls.push(normalized);
                        seen.add(normalized);
                    }
                }
            }
            return urls; // No limit
        }

        function extractUrlsFromLines(text) {
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);
            const urls = [];
            const seen = new Set(); // Track unique URLs
            
            for (const line of lines) {
                const normalized = normalizeUrl(line);
                if (normalized && !seen.has(normalized)) {
                    urls.push(normalized);
                    seen.add(normalized);
                }
            }
            return urls; // No limit
        }

        function showUrlPreview(urls) {
            const preview = document.getElementById('csvPreview');
            const urlsList = document.getElementById('csvUrlsList');
            preview.style.display = 'block';
            urlsList.innerHTML = `<strong>${urls.length} URLs extracted:</strong><br>` + 
                urls.slice(0, 5).map(url => `‚Ä¢ ${url.length > 60 ? url.substring(0, 60) + '...' : url}`).join('<br>') +
                (urls.length > 5 ? `<br><em>... and ${urls.length - 5} more</em>` : '');
        }

        function clearCsvUpload() {
            document.getElementById('csvFile').value = '';
            document.getElementById('bulkUrls').value = '';
            document.getElementById('csvColumnSelection').style.display = 'none';
            document.getElementById('csvPreview').style.display = 'none';
            csvData = null;
            csvColumns = [];
        }

        function addQuickSelector(fieldName, selector) {
            const container = document.getElementById('selectorsContainer');
            
            // Check if this field already exists
            const existingRows = container.querySelectorAll('.selector-row');
            for (const row of existingRows) {
                const existingFieldName = row.querySelector('.field-name').value.trim();
                if (existingFieldName === fieldName) {
                    // Update existing selector
                    row.querySelector('.css-selector').value = selector;
                    row.querySelector('.css-selector').style.background = '#d1fae5';
                    setTimeout(() => {
                        row.querySelector('.css-selector').style.background = '';
                    }, 1000);
                    return;
                }
            }
            
            // Add new selector
            const row = document.createElement('div');
            row.className = 'selector-row';
            row.innerHTML = `
                <input type="text" placeholder="Field Name" class="field-name" value="${fieldName}" required>
                <input type="text" placeholder="CSS Selector" class="css-selector" value="${selector}" required>
                <button type="button" class="btn btn-small" onclick="removeSelector(this)">Remove</button>
            `;
            container.appendChild(row);
            
            // Highlight the new row
            row.style.background = '#d1fae5';
            setTimeout(() => {
                row.style.background = '';
            }, 1000);
        }

        function addAllBusinessSelectors() {
            const selectors = [
                { name: 'Company Name', selector: 'h1, h1.title, .company-name, .brand, .logo-text, [itemprop="name"], .site-title, title, meta[property="og:site_name"], header h1, .header h1, nav .brand, .navbar-brand' },
                { name: 'Homepage URL', selector: 'a.logo[href], a[href="/"], .homepage-link, a.brand[href], header a[href="/"], nav a[href="/"], .logo a[href]' },
                { name: 'Email', selector: 'a[href^="mailto:"], [itemprop="email"], .email, .contact-email, a.email, .mail, a[href*="mailto"], *[href^="mailto:"]' },
                { name: 'Phone', selector: 'a[href^="tel:"], [itemprop="telephone"], .phone, .contact-phone, a.phone, .tel, a[href*="tel:"], *[href^="tel:"]' },
                { name: 'Contact Page URL', selector: 'a[href*="contact"], a.contact-link, nav a[href*="contact"], a[href*="contact-us"], a[href*="contactus"], footer a[href*="contact"]' },
                { name: 'Social Media URLs', selector: 'a[href*="facebook.com"], a[href*="twitter.com"], a[href*="linkedin.com"], a[href*="instagram.com"], a[href*="youtube.com"], .social-link, a.social, .social-media a, footer a[href*="facebook"], footer a[href*="twitter"], footer a[href*="linkedin"]' }
            ];
            
            // Clear existing selectors
            const container = document.getElementById('selectorsContainer');
            container.innerHTML = '';
            
            // Add all selectors
            selectors.forEach(({ name, selector }) => {
                const row = document.createElement('div');
                row.className = 'selector-row';
                row.innerHTML = `
                    <input type="text" placeholder="Field Name" class="field-name" value="${name}" required>
                    <input type="text" placeholder="CSS Selector" class="css-selector" value="${selector}" required>
                    <button type="button" class="btn btn-small" onclick="removeSelector(this)">Remove</button>
                `;
                container.appendChild(row);
            });
            
            // Show success message
            const message = document.createElement('div');
            message.style.cssText = 'background: #d1fae5; color: #065f46; padding: 10px; border-radius: 6px; margin-top: 10px;';
            message.textContent = '‚úÖ All business info selectors added!';
            container.parentElement.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const bulkMode = document.getElementById('bulkMode').checked;
            const url = document.getElementById('url').value;
            const bulkUrlsText = document.getElementById('bulkUrls').value;
            const scrapingMethod = document.getElementById('scrapingMethod').value;
            const userAgent = document.getElementById('userAgent').value;
            const waitTime = parseFloat(document.getElementById('waitTime').value) || 0;
            const delayBetweenUrls = parseFloat(document.getElementById('delayBetweenUrls').value) || 0;
            
            // Collect selectors (optional - predefined fields are auto-extracted)
            const selectors = {};
            const rows = document.querySelectorAll('.selector-row');
            for (const row of rows) {
                const fieldName = row.querySelector('.field-name').value.trim();
                const selector = row.querySelector('.css-selector').value.trim();
                if (fieldName && selector) {
                    selectors[fieldName] = selector;
                }
            }
            
            // Show loading
            loading.classList.add('active');
            responseSection.style.display = 'none';
            submitBtn.disabled = true;
            
            try {
                if (bulkMode) {
                    const csvFile = document.getElementById('csvFile').files[0];
                    const hasFile = csvFile && csvFile.size > 0;
                    const hasText = bulkUrlsText.trim().length > 0;
                    
                    // Check if we have at least one input method
                    if (!hasFile && !hasText) {
                        alert('Please enter URLs in the text area or upload a CSV/TXT file');
                        loading.classList.remove('active');
                        submitBtn.disabled = false;
                        return;
                    }
                    
                    // If file is uploaded, use FormData; otherwise use JSON
                    let response;
                    if (hasFile) {
                        // Use FormData for file upload
                        const formData = new FormData();
                        formData.append('urls_text', bulkUrlsText);
                        formData.append('urls_file', csvFile);
                        formData.append('selectors', JSON.stringify(selectors));
                        formData.append('method', scrapingMethod);
                        formData.append('user_agent', userAgent);
                        formData.append('wait_time', waitTime.toString());
                        formData.append('delay_between_urls', delayBetweenUrls.toString());
                        
                        // Optional name field
                        const nameInput = document.getElementById('requestName');
                        if (nameInput && nameInput.value) {
                            formData.append('name', nameInput.value);
                        }
                        
                        response = await fetch('/api/web-scrape-bulk/', {
                            method: 'POST',
                            body: formData,
                            signal: AbortSignal.timeout(300000) // 5 minute timeout for initial response
                        });
                    } else {
                        // Use JSON for text-only input (backward compatibility)
                        const urlLines = bulkUrlsText.split('\n').map(line => line.trim()).filter(line => line);
                        const urls = [];
                        const seen = new Set();
                        
                        for (const line of urlLines) {
                            const normalized = normalizeUrl(line);
                            if (normalized && !seen.has(normalized)) {
                                urls.push(normalized);
                                seen.add(normalized);
                            }
                        }
                        
                        if (urls.length === 0) {
                            alert('Please enter at least one valid URL');
                            loading.classList.remove('active');
                            submitBtn.disabled = false;
                            return;
                        }
                        
                        response = await fetch('/api/web-scrape-bulk/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                urls_text: bulkUrlsText,
                                selectors: selectors,
                                method: scrapingMethod,
                                user_agent: userAgent,
                                wait_time: waitTime,
                                delay_between_urls: delayBetweenUrls
                            }),
                            signal: AbortSignal.timeout(300000) // 5 minute timeout for initial response
                        });
                    }
                    
                    const result = await response.json();
                    
                    // If we have a request_id, start polling for progress
                    if (response.ok && result.request_id) {
                        // Show response section immediately with initial status
                        responseSection.style.display = 'block';
                        statusBadge.textContent = 'Starting...';
                        statusBadge.className = 'status-badge status-success';
                        responseContent.textContent = 'Bulk scraping job started. Polling for progress...';
                        
                        // Poll for progress
                        const pollProgress = async () => {
                            try {
                                const progressResponse = await fetch(`/api/web-scrape-progress/?request_id=${result.request_id}`, {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'application/json',
                                    },
                                    cache: 'no-cache'
                                });
                                
                                if (!progressResponse.ok) {
                                    console.error('Progress response not OK:', progressResponse.status, progressResponse.statusText);
                                    statusBadge.textContent = `Error: ${progressResponse.status}`;
                                    statusBadge.className = 'status-badge status-error';
                                    setTimeout(pollProgress, 5000);
                                    return;
                                }
                                
                                const progressData = await progressResponse.json();
                                
                                if (progressData.success && progressData.progress) {
                                    const progress = progressData.progress;
                                    statusBadge.textContent = `Processing: ${progress.completed + progress.failed}/${progress.total}`;
                                    statusBadge.className = 'status-badge status-success';
                                    responseContent.textContent = `Status: ${progress.status}\n${progress.message}\n\nProgress: ${progress.completed} completed, ${progress.failed} failed out of ${progress.total} total URLs`;
                                    
                                    if (progress.status === 'completed' || (progress.completed + progress.failed) >= progress.total) {
                                        // Fetch final results
                                        const finalResponse = await fetch('/api/web-scrape-bulk/', {
                                            method: 'POST',
                                            headers: {'Content-Type': 'application/json'},
                                            body: JSON.stringify({get_results: true, request_id: result.request_id})
                                        });
                                        const finalResult = await finalResponse.json();
                                        
                                        if (finalResult.success) {
                                            const formattedResults = {
                                                summary: {
                                                    total_urls: finalResult.total_urls,
                                                    completed: finalResult.completed,
                                                    failed: finalResult.failed
                                                },
                                                results: finalResult.results
                                            };
                                            responseContent.textContent = JSON.stringify(formattedResults, null, 2);
                                            currentData = formattedResults;
                                            statusBadge.textContent = `Completed: ${finalResult.completed}/${finalResult.total_urls}`;
                                            statusBadge.className = 'status-badge status-success';
                                            exportCsvBtn.style.display = 'inline-block';
                                            exportJsonBtn.style.display = 'inline-block';
                                            loading.classList.remove('active');
                                            submitBtn.disabled = false;
                                        } else {
                                            statusBadge.textContent = 'Error fetching results';
                                            statusBadge.className = 'status-badge status-error';
                                            responseContent.textContent = finalResult.error || 'Failed to fetch results';
                                            loading.classList.remove('active');
                                            submitBtn.disabled = false;
                                        }
                                    } else {
                                        // Continue polling
                                        setTimeout(pollProgress, 2000); // Poll every 2 seconds
                                    }
                                } else {
                                    console.warn('Invalid progress data:', progressData);
                                    statusBadge.textContent = 'Invalid response';
                                    statusBadge.className = 'status-badge status-error';
                                    responseContent.textContent = 'Received invalid progress data. Retrying...';
                                    setTimeout(pollProgress, 2000);
                                }
                            } catch (error) {
                                console.error('Error polling progress:', error);
                                statusBadge.textContent = 'Connection error';
                                statusBadge.className = 'status-badge status-error';
                                responseContent.textContent = `Error: ${error.message}. Retrying...`;
                                // Continue polling even on error
                                setTimeout(pollProgress, 5000); // Retry after 5 seconds on error
                            }
                        };
                        
                        // Start polling after a short delay
                        setTimeout(pollProgress, 1000);
                        return; // Exit early, polling will handle the rest
                    }
                    
                    if (response.ok && result.success) {
                        // Show progress and results
                        statusBadge.textContent = `Completed: ${result.completed}/${result.total_urls}`;
                        statusBadge.className = 'status-badge status-success';
                        
                        // Format results for display
                        const formattedResults = {
                            summary: {
                                total_urls: result.total_urls,
                                completed: result.completed,
                                failed: result.failed
                            },
                            results: result.results
                        };
                        
                        responseContent.textContent = JSON.stringify(formattedResults, null, 2);
                        currentData = formattedResults;
                        responseSection.style.display = 'block';
                        exportCsvBtn.style.display = 'inline-block';
                        exportJsonBtn.style.display = 'inline-block';
                    } else {
                        statusBadge.textContent = 'Error';
                        statusBadge.className = 'status-badge status-error';
                        responseContent.textContent = result.error || 'Unknown error occurred';
                        currentData = null;
                        exportCsvBtn.style.display = 'none';
                        exportJsonBtn.style.display = 'none';
                        responseSection.style.display = 'block';
                    }
                } else {
                    // Single URL scraping - normalize URL
                    const normalizedUrl = normalizeUrl(url);
                    if (!normalizedUrl) {
                        alert('Please enter a valid URL');
                        loading.classList.remove('active');
                        submitBtn.disabled = false;
                        return;
                    }
                    
                    const response = await fetch('/api/web-scrape/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            url: normalizedUrl,
                            selectors: selectors,
                            method: scrapingMethod,
                            user_agent: userAgent,
                            wait_time: waitTime
                        })
                    });
                    
                    const result = await response.json();
                    
                    // Hide loading
                    loading.classList.remove('active');
                    submitBtn.disabled = false;
                    
                    // Show response
                    responseSection.style.display = 'block';
                    
                    if (response.ok && result.success) {
                        statusBadge.textContent = 'Success';
                        statusBadge.className = 'status-badge status-success';
                        
                        // Format the data for better readability, especially arrays
                        const formattedData = {};
                        for (const [key, value] of Object.entries(result.extracted_data)) {
                            if (Array.isArray(value)) {
                                // For arrays (like Social Media URLs), keep them as arrays
                                formattedData[key] = value;
                            } else {
                                formattedData[key] = value;
                            }
                        }
                        
                        responseContent.textContent = JSON.stringify(formattedData, null, 2);
                        currentData = result.extracted_data;
                        exportCsvBtn.style.display = 'inline-block';
                        exportJsonBtn.style.display = 'inline-block';
                    } else {
                        statusBadge.textContent = 'Error';
                        statusBadge.className = 'status-badge status-error';
                        responseContent.textContent = result.error || 'Unknown error occurred';
                        currentData = null;
                        exportCsvBtn.style.display = 'none';
                        exportJsonBtn.style.display = 'none';
                    }
                }
            } catch (error) {
                loading.classList.remove('active');
                submitBtn.disabled = false;
                responseSection.style.display = 'block';
                statusBadge.textContent = 'Error';
                statusBadge.className = 'status-badge status-error';
                responseContent.textContent = `Error: ${error.message}`;
                currentData = null;
                exportCsvBtn.style.display = 'none';
                exportJsonBtn.style.display = 'none';
            }
        });

        // Helper function to convert any value to a string
        function valueToString(value) {
            if (value === null || value === undefined) {
                return '';
            }
            if (typeof value === 'boolean') {
                return value ? 'true' : 'false';
            }
            if (typeof value === 'number') {
                return String(value);
            }
            if (typeof value === 'string') {
                return value;
            }
            if (Array.isArray(value)) {
                // Convert array to JSON string
                return JSON.stringify(value);
            }
            if (typeof value === 'object') {
                // Convert objects to JSON string
                try {
                    return JSON.stringify(value);
                } catch (e) {
                    // Fallback if JSON.stringify fails
                    return String(value);
                }
            }
            return String(value);
        }

        // Helper function to flatten nested objects
        function flattenObject(obj, prefix = '', result = {}) {
            if (obj === null || obj === undefined) {
                return result;
            }
            
            // Handle arrays
            if (Array.isArray(obj)) {
                if (obj.length === 0) {
                    if (prefix) {
                        result[prefix] = '';
                    }
                } else if (obj.length === 1) {
                    // Single item array - flatten it
                    if (typeof obj[0] === 'object' && obj[0] !== null && !Array.isArray(obj[0])) {
                        flattenObject(obj[0], prefix, result);
                    } else {
                        result[prefix || 'value'] = valueToString(obj[0]);
                    }
                } else {
                    // Multiple items - join with semicolon
                    const stringValues = obj.map(item => {
                        if (item === null || item === undefined) {
                            return '';
                        }
                        if (typeof item === 'object') {
                            return JSON.stringify(item);
                        }
                        return String(item);
                    }).filter(v => v !== '');
                    result[prefix || 'value'] = stringValues.join('; ');
                }
                return result;
            }
            
            // Handle non-objects (primitives)
            if (typeof obj !== 'object') {
                if (prefix) {
                    result[prefix] = valueToString(obj);
                }
                return result;
            }
            
            // Handle objects
            for (const key in obj) {
                if (obj.hasOwnProperty(key) && obj[key] !== undefined) {
                    const newKey = prefix ? `${prefix}.${key}` : key;
                    const value = obj[key];
                    
                    if (value === null) {
                        result[newKey] = '';
                    } else if (Array.isArray(value)) {
                        // Handle arrays
                        if (value.length === 0) {
                            result[newKey] = '';
                        } else if (value.length === 1) {
                            // Single item array - flatten it
                            if (typeof value[0] === 'object' && value[0] !== null && !Array.isArray(value[0])) {
                                flattenObject(value[0], newKey, result);
                            } else {
                                result[newKey] = valueToString(value[0]);
                            }
                        } else {
                            // Multiple items - join with semicolon
                            const stringValues = value.map(item => {
                                if (item === null || item === undefined) {
                                    return '';
                                }
                                if (typeof item === 'object') {
                                    return JSON.stringify(item);
                                }
                                return String(item);
                            }).filter(v => v !== '');
                            result[newKey] = stringValues.join('; ');
                        }
                    } else if (typeof value === 'object' && value !== null) {
                        // Recursively flatten nested objects
                        flattenObject(value, newKey, result);
                    } else {
                        result[newKey] = valueToString(value);
                    }
                }
            }
            return result;
        }

        exportCsvBtn.addEventListener('click', () => {
            if (!currentData) return;
            
            try {
                let records = [];
                
                // Handle different data structures
                if (currentData.results && Array.isArray(currentData.results)) {
                    // Bulk scraping results - each result has {url, success, data, status_code, error}
                    records = currentData.results.map(result => {
                        // Start with metadata fields
                        const record = {};
                        
                        // Add URL
                        if (result.url) {
                            record['URL'] = String(result.url);
                        }
                        
                        // Add Success
                        if (result.success !== undefined) {
                            record['Success'] = result.success ? 'Yes' : 'No';
                        }
                        
                        // Add Status Code
                        if (result.status_code !== undefined) {
                            record['Status Code'] = String(result.status_code);
                        }
                        
                        // Add Error
                        if (result.error) {
                            record['Error'] = String(result.error);
                        }
                        
                        // Extract actual data from result.data or result.extracted_data
                        const data = result.data || result.extracted_data || {};
                        
                        // Flatten and merge the extracted data
                        const flattenedData = flattenObject(data);
                        for (const key in flattenedData) {
                            if (flattenedData.hasOwnProperty(key)) {
                                record[key] = flattenedData[key];
                            }
                        }
                        
                        // Add summary info if available
                        if (currentData.summary) {
                            if (currentData.summary.total_urls !== undefined) {
                                record['_Summary_Total_URLs'] = String(currentData.summary.total_urls);
                            }
                            if (currentData.summary.completed !== undefined) {
                                record['_Summary_Completed'] = String(currentData.summary.completed);
                            }
                            if (currentData.summary.failed !== undefined) {
                                record['_Summary_Failed'] = String(currentData.summary.failed);
                            }
                        }
                        
                        return record;
                    });
                } else if (Array.isArray(currentData)) {
                    // Direct array of records - assume each is a result object
                    records = currentData.map(result => {
                        const record = {
                            'URL': result.url || '',
                            'Success': result.success !== undefined ? (result.success ? 'Yes' : 'No') : '',
                            'Status Code': result.status_code || '',
                            'Error': result.error || ''
                        };
                        
                        const data = result.data || result.extracted_data || result;
                        const flattenedData = flattenObject(data);
                        Object.assign(record, flattenedData);
                        
                        return record;
                    });
                } else if (currentData.extracted_data) {
                    // Single scraping result with extracted_data
                    const record = {
                        'URL': currentData.url || '',
                        'Success': 'Yes',
                        'Status Code': currentData.status_code || ''
                    };
                    const flattenedData = flattenObject(currentData.extracted_data);
                    Object.assign(record, flattenedData);
                    records = [record];
                } else if (currentData.data) {
                    // Single result with data field
                    const record = {
                        'URL': currentData.url || '',
                        'Success': currentData.success !== undefined ? (currentData.success ? 'Yes' : 'No') : '',
                        'Status Code': currentData.status_code || '',
                        'Error': currentData.error || ''
                    };
                    const flattenedData = flattenObject(currentData.data);
                    Object.assign(record, flattenedData);
                    records = [record];
                } else {
                    // Single object - treat as one record
                    const record = {
                        'URL': currentData.url || '',
                        'Success': currentData.success !== undefined ? (currentData.success ? 'Yes' : 'No') : ''
                    };
                    const flattenedData = flattenObject(currentData);
                    Object.assign(record, flattenedData);
                    records = [record];
                }
                
                if (records.length === 0) {
                    alert('No data to export');
                    return;
                }
                
                // Flatten all records (in case there are still nested structures)
                const flattenedRecords = records.map(record => {
                    // First flatten the record
                    const flattened = flattenObject(record);
                    
                    // Then ensure all values are strings (no objects left)
                    const cleaned = {};
                    for (const key in flattened) {
                        if (flattened.hasOwnProperty(key)) {
                            let val = flattened[key];
                            
                            // Convert to string, handling all edge cases
                            if (val === null || val === undefined) {
                                cleaned[key] = '';
                            } else if (typeof val === 'boolean') {
                                cleaned[key] = val ? 'true' : 'false';
                            } else if (typeof val === 'number') {
                                cleaned[key] = String(val);
                            } else if (typeof val === 'string') {
                                cleaned[key] = val;
                            } else if (Array.isArray(val)) {
                                // Convert array to JSON string
                                try {
                                    cleaned[key] = JSON.stringify(val);
                                } catch (e) {
                                    cleaned[key] = String(val);
                                }
                            } else if (typeof val === 'object') {
                                // Convert object to JSON string
                                try {
                                    cleaned[key] = JSON.stringify(val);
                                } catch (e) {
                                    // If JSON.stringify fails, try toString
                                    const str = String(val);
                                    // If it's still [object Object], try to inspect it
                                    if (str === '[object Object]') {
                                        try {
                                            cleaned[key] = JSON.stringify(val, null, 2);
                                        } catch (e2) {
                                            cleaned[key] = '';
                                        }
                                    } else {
                                        cleaned[key] = str;
                                    }
                                }
                            } else {
                                cleaned[key] = String(val);
                            }
                        }
                    }
                    return cleaned;
                });
                
                // Collect all unique field names
                const allFields = new Set();
                flattenedRecords.forEach(record => {
                    Object.keys(record).forEach(key => allFields.add(key));
                });
                
                // Sort headers: URL, Success, Status Code, Error first, then alphabetically
                // Exclude any keys that look like they might be objects
                const priorityFields = ['URL', 'Success', 'Status Code', 'Error'];
                const otherFields = Array.from(allFields)
                    .filter(f => !priorityFields.includes(f) && !f.startsWith('_summary'))
                    .sort();
                const headers = [...priorityFields.filter(f => allFields.has(f)), ...otherFields];
                
                // Build CSV content
                const csvRows = [];
                
                // Add header row
                csvRows.push(headers.map(h => `"${h.replace(/"/g, '""')}"`).join(','));
                
                // Add data rows
                flattenedRecords.forEach(record => {
                    const row = headers.map(header => {
                        let value = record[header];
                        
                        // If value is undefined or null, use empty string
                        if (value === undefined || value === null) {
                            value = '';
                        }
                        
                        // Ensure value is always a string
                        let stringValue;
                        if (typeof value === 'string') {
                            stringValue = value;
                        } else if (typeof value === 'object') {
                            // This shouldn't happen if flattening worked, but handle it anyway
                            try {
                                stringValue = JSON.stringify(value);
                            } catch (e) {
                                stringValue = String(value);
                            }
                        } else {
                            stringValue = String(value);
                        }
                        
                        // Check if this looks like a phone number or long number that Excel might convert
                        // Phone numbers often start with + or contain spaces, dashes, parentheses
                        const isPhoneNumber = /^[\+\d\s\-\(\)]+$/.test(stringValue) && 
                                             (stringValue.includes('+') || stringValue.includes(' ') || 
                                              stringValue.includes('-') || stringValue.includes('(') ||
                                              stringValue.length > 10);
                        
                        // Check if it's a long numeric string (Excel will convert to scientific notation)
                        const isLongNumber = /^\d+$/.test(stringValue) && stringValue.length > 10;
                        
                        // For phone numbers and long numbers, prepend with tab to force Excel to treat as text
                        // Or use the formula approach: ="value" to force text interpretation
                        if (isPhoneNumber || isLongNumber) {
                            // Prepend with single quote to force Excel to treat as text
                            // Or use the formula approach
                            stringValue = '="' + stringValue.replace(/"/g, '""') + '"';
                        } else {
                            // Escape quotes and wrap in quotes normally
                            stringValue = '"' + stringValue.replace(/"/g, '""') + '"';
                        }
                        
                        return stringValue;
                    });
                    csvRows.push(row.join(','));
                });
                
                const csvContent = csvRows.join('\n');
                
                // Create and download file
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `scraped_data_${new Date().getTime()}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error exporting CSV:', error);
                alert('Error exporting CSV: ' + error.message);
            }
        });

        exportJsonBtn.addEventListener('click', () => {
            if (!currentData) return;
            
            const jsonContent = JSON.stringify(currentData, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'scraped_data.json';
            a.click();
            window.URL.revokeObjectURL(url);
        });

        // Set active menu item
        (function() {
            const currentPath = window.location.pathname;
            const menuLinks = document.querySelectorAll('.nav-menu-link');
            menuLinks.forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
        })();

        // Ensure functions are accessible globally immediately
        window.toggleBulkMode = toggleBulkMode;
        window.toggleExampleSelectors = toggleExampleSelectors;
        window.addSelector = addSelector;
        window.removeSelector = removeSelector;
        
        // Initialize event listeners on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Bulk mode checkbox
            const bulkModeCheckbox = document.getElementById('bulkMode');
            const csvUploadSection = document.getElementById('csvUploadSection');
            
            if (bulkModeCheckbox) {
                bulkModeCheckbox.addEventListener('change', toggleBulkMode);
                if (bulkModeCheckbox.checked) {
                    toggleBulkMode();
                }
            }
            
            // Example selectors toggle
            const exampleSelectorsHeader = document.getElementById('exampleSelectorsHeader');
            if (exampleSelectorsHeader) {
                exampleSelectorsHeader.addEventListener('click', toggleExampleSelectors);
            }
            
            console.log('DOMContentLoaded - Elements initialized:', {
                bulkModeCheckbox,
                csvUploadSection,
                exampleSelectorsHeader
            });
        });
        
        // Immediate initialization (runs before DOMContentLoaded if script is at end of body)
        (function() {
            // Set up example selectors header click handler
            const exampleSelectorsHeader = document.getElementById('exampleSelectorsHeader');
            if (exampleSelectorsHeader) {
                exampleSelectorsHeader.addEventListener('click', toggleExampleSelectors);
            }
            
            // Set up bulk mode checkbox handler
            const bulkModeCheckbox = document.getElementById('bulkMode');
            if (bulkModeCheckbox) {
                bulkModeCheckbox.addEventListener('change', toggleBulkMode);
                if (bulkModeCheckbox.checked) {
                    toggleBulkMode();
                }
            }
        })();
    </script>
</body>
</html>
